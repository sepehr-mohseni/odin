# Request Transformation Templates

Odin supports powerful request and response transformations using Go templates, allowing you to modify headers, query parameters, and body content on the fly.

## Features

- **Header transformations**: Add, modify, or remove headers
- **Query parameter transformations**: Transform URL query parameters
- **Body transformations**: Transform JSON request/response bodies
- **Template functions**: Rich set of helper functions (upper, lower, split, join, etc.)
- **Conditional logic**: Use Go template conditionals and loops

## Configuration

The transformation feature is not yet integrated into the service configuration but the engine is ready. Here's how it will work:

```yaml
services:
  - name: my-service
    basePath: /api/service
    targets:
      - http://backend:8080
    transformations:
      request:
        headers:
          X-API-Key: "{{ default \"default-key\" .X-API-Key }}"
          X-User-ID: "{{ upper .X-User-ID }}"
        queryParams:
          page: "{{ default \"1\" .page }}"
          limit: "{{ default \"10\" .limit }}"
        body: |
          {
            "user": {
              "name": "{{ .name }}",
              "email": "{{ lower .email }}"
            },
            "timestamp": "{{.timestamp}}"
          }
      response:
        headers:
          X-Response-Time: "Generated by Odin"
        body: |
          {
            "status": "success",
            "data": {{ toJson . }},
            "statusCode": {{ .statusCode }}
          }
```

## Template Functions

The transformation engine provides these helper functions:

| Function | Description | Example |
|----------|-------------|---------|
| `upper` | Convert to uppercase | `{{ upper .name }}` |
| `lower` | Convert to lowercase | `{{ lower .email }}` |
| `title` | Title case | `{{ title .name }}` |
| `trim` | Trim whitespace | `{{ trim .text }}` |
| `replace` | Replace substring | `{{ replace .text "old" "new" }}` |
| `contains` | Check substring | `{{ if contains .text "hello" }}` |
| `split` | Split string | `{{ split .tags "," }}` |
| `join` | Join strings | `{{ join .items "," }}` |
| `default` | Default value | `{{ default "N/A" .optional }}` |
| `toJson` | Convert to JSON | `{{ toJson .data }}` |
| `fromJson` | Parse JSON | `{{ $obj := fromJson .json }}` |

## Use Cases

### 1. Adding Authentication Headers

```yaml
transformations:
  request:
    headers:
      Authorization: "Bearer {{ .X-API-Token }}"
```

### 2. Normalizing Query Parameters

```yaml
transformations:
  request:
    queryParams:
      page: "{{ default \"1\" .page }}"
      per_page: "{{ default \"20\" .limit }}"
```

### 3. Transforming Request Body

```yaml
transformations:
  request:
    body: |
      {
        "user_name": "{{ lower .username }}",
        "user_email": "{{ lower .email }}",
        "created_at": "2024-01-01T00:00:00Z"
      }
```

### 4. Wrapping Response

```yaml
transformations:
  response:
    body: |
      {
        "success": true,
        "data": {{ toJson . }},
        "meta": {
          "statusCode": {{ .statusCode }},
          "timestamp": "{{ now }}"
        }
      }
```

### 5. Field Renaming

```yaml
transformations:
  request:
    body: |
      {
        "firstName": "{{ .first_name }}",
        "lastName": "{{ .last_name }}",
        "emailAddress": "{{ .email }}"
      }
```

### 6. Conditional Transformations

```yaml
transformations:
  request:
    body: |
      {
        "name": "{{ .name }}",
        {{- if .premium }}
        "tier": "premium",
        {{- else }}
        "tier": "free",
        {{- end }}
        "features": ["basic"]
      }
```

## Template Context

### Request Transformations

For **headers** and **queryParams**, the template context contains:
- All existing headers/query parameters as fields
- Example: `{{ .Content-Type }}` accesses the Content-Type header

For **body** transformations:
- JSON bodies are parsed and fields are accessible directly
- Example: `{{ .user.name }}` for `{"user": {"name": "John"}}`
- Non-JSON bodies are available as `{{ .body }}`

### Response Transformations

For **response body** transformations:
- JSON response is parsed and accessible
- `{{ .statusCode }}` - HTTP status code
- `{{ .body }}` - Raw response body (if not JSON)

## Examples

### Example 1: API Version Migration

Transform old API format to new:

```yaml
transformations:
  request:
    body: |
      {
        "version": "2.0",
        "payload": {
          "user_id": "{{ .userId }}",
          "user_name": "{{ .userName }}",
          "user_email": "{{ .userEmail }}"
        }
      }
```

### Example 2: Adding Metadata

Add gateway metadata to all responses:

```yaml
transformations:
  response:
    body: |
      {
        "data": {{ toJson . }},
        "meta": {
          "gateway": "odin",
          "timestamp": "{{ now }}",
          "version": "1.0"
        }
      }
```

### Example 3: Data Sanitization

Sanitize and normalize inputs:

```yaml
transformations:
  request:
    body: |
      {
        "email": "{{ trim (lower .email) }}",
        "username": "{{ trim .username }}",
        "age": {{ default 0 .age }}
      }
```

## Performance Considerations

- Templates are compiled once and cached
- JSON parsing happens only for JSON content
- Failed transformations log errors but don't block requests
- Use transformations sparingly for high-traffic endpoints

## Coming Soon

The transformation engine is complete but not yet integrated into the routing handler. Integration is planned for the next release.
